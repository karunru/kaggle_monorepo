[tools]
python = ["3.12"]
uv = "0.6.9"
hadolint = "2.12.0"
pre-commit = "4.2.0"
actionlint = "1.7.7"

############################################
# Tasks for python project
############################################

[tasks.format]
description = "Format python code by ruff"
run = "uvx ruff@latest format ${PWD}"

[tasks.ci-format]
description = "Check format by ruff"
run = "uvx ruff@latest format --check"

[tasks.lint]
description = "Lint python code by ruff with auto-fix"
run = "uvx ruff@latest check --fix ${PWD}"

[tasks.ci-lint]
description = "Check lint by ruff"
run = "uvx ruff@latest check"

[tasks.type-check]
description = "Check types by mypy"
run = "uvx mypy@latest ${PWD}"

[tasks.ci-type-check]
description = "Check types by mypy"
run = "uvx mypy@latest ."

[tasks.test]
description = "Run pytest in tests directory"
run = "uvx pytest"

[tasks.all]
description = "Run format, lint, type-check, test"
depends = ["format", "lint", "type-check", "test"]


############################################
# Tasks for docker project
############################################
[tasks.hadolint]
description = "Lint Dockerfile by hadolint"
run = "hadolint Dockerfile"

[tasks.compose-up]
description = "Start up all the services in detached mode"
run = """
export UID=$(id -u)
export GID=$(id -g)
export PROJECT={{arg(name='project', var=true)}}
docker compose up -d --build
"""

[tasks.compose-down]
description = "Compose down"
run = "docker compose down"


############################################
# Tasks for workspace
############################################

[tasks.new]
description = "Create a new project from template"
run = """
PROJECT_NAME={{arg(name='project_name', var=true)}}

REPO_ROOT=$(git rev-parse --show-toplevel)
PROJECT_DIR=${REPO_ROOT}/projects/${PROJECT_NAME}
TEMPLATE_DIR=${REPO_ROOT}/projects/template

mkdir -p ${PROJECT_DIR}
cp -r ${TEMPLATE_DIR}/* ${PROJECT_DIR}/ 2>/dev/null || true
find ${TEMPLATE_DIR} -name ".*" -type f -exec cp {} ${PROJECT_DIR}/ \\; 2>/dev/null || true
sed -i 's/name = "template"/name = "'${PROJECT_NAME}'"/g' ${PROJECT_DIR}/pyproject.toml
rm projects/${PROJECT_NAME}/**/.gitkeep
rm projects/${PROJECT_NAME}/.gitkeep
echo "Project ${PROJECT_NAME} created from template and added to workspace members"
"""

[tasks.comp-init]
description = "Initialize a competition project with its own private git repo"
run = """
PROJECT_NAME={{arg(name='project_name', var=true)}}
GITHUB_USER={{arg(name='github_user', default='karunru', var=true)}}

REPO_ROOT=$(git rev-parse --show-toplevel)
PROJECT_DIR=${REPO_ROOT}/projects/${PROJECT_NAME}

# Check if project directory exists
if [ ! -d "${PROJECT_DIR}" ]; then
  echo "Error: Project directory ${PROJECT_DIR} does not exist"
  echo "Please run 'mise run new ${PROJECT_NAME}' first"
  exit 1
fi

# Check if already initialized
if [ -d "${PROJECT_DIR}/.git" ]; then
  echo "Error: ${PROJECT_DIR}/.git already exists"
  echo "This project is already initialized as a competition project"
  exit 1
fi

# Check if gh CLI is installed
if ! command -v gh &> /dev/null; then
  echo "Error: GitHub CLI (gh) is not installed"
  echo "Please install it: https://cli.github.com/"
  exit 1
fi

# Check if GitHub repository already exists
if gh repo view ${GITHUB_USER}/${PROJECT_NAME} &> /dev/null; then
  echo "Error: GitHub repository ${GITHUB_USER}/${PROJECT_NAME} already exists"
  exit 1
fi

echo "Initializing ${PROJECT_NAME} as a private competition project..."

# Initialize git in project directory and push to private repo
cd ${PROJECT_DIR}
git init
git add .
git commit -m "Initial commit from kaggle_monorepo template"
gh repo create ${GITHUB_USER}/${PROJECT_NAME} --private --source=. --remote=origin --push

echo ""
echo "Done! Project ${PROJECT_NAME} initialized as private competition project"
echo "  - Private repo: https://github.com/${GITHUB_USER}/${PROJECT_NAME}"
echo "  - Work in: projects/${PROJECT_NAME}/"
echo "  - Push: cd projects/${PROJECT_NAME} && git add . && git commit -m 'msg' && git push"
echo "  - Publish after competition: mise run comp-publish ${PROJECT_NAME}"
"""

[tasks.comp-publish]
description = "Integrate a finished competition project into the public monorepo"
run = """
PROJECT_NAME={{arg(name='project_name', var=true)}}
GITHUB_USER={{arg(name='github_user', default='karunru', var=true)}}

REPO_ROOT=$(git rev-parse --show-toplevel)
PROJECT_DIR=${REPO_ROOT}/projects/${PROJECT_NAME}

# Check if project has .git
if [ ! -d "${PROJECT_DIR}/.git" ]; then
  echo "Error: ${PROJECT_DIR}/.git not found"
  echo "This project does not appear to be an active competition project"
  exit 1
fi

echo "Publishing ${PROJECT_NAME} to the public monorepo..."
echo "This will:"
echo "  1. Remove projects/${PROJECT_NAME}/.git/ (detach from private repo)"
echo "  2. Stage all project files for the monorepo"
echo ""
read -p "Continue? (y/N) " CONFIRM
if [ "$CONFIRM" != "y" ] && [ "$CONFIRM" != "Y" ]; then
  echo "Aborted."
  exit 0
fi

# Remove nested git
rm -rf ${PROJECT_DIR}/.git

# Stage project files
cd ${REPO_ROOT}
git add projects/${PROJECT_NAME}/

echo ""
echo "Done! Project files staged."
echo "  Review: git status && git diff --cached --stat"
echo "  Commit: git commit -m 'Integrate ${PROJECT_NAME} (competition ended)'"
echo ""
echo "Optional: Make the private repo public:"
echo "  gh repo edit ${GITHUB_USER}/${PROJECT_NAME} --visibility public"
"""