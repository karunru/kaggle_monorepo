# exp016 実装計画書

## 概要

exp015をベースとして、ImuFeatureExtractorで作成する特徴量をexp013と同等にする実装。
exp015は現在39次元の特徴量を生成しているが、exp013の特徴量計算ロジックと合わせることで精度向上を図る。

## 背景・問題分析

### exp013の特徴量生成（dataset.py内で処理）
- **基本IMUデータ**: 7次元（acc_x/y/z, rot_w/x/y/z）
- **物理ベース特徴量**: 9次元
  - linear_acc_x/y/z（Polarsで重力除去）
  - linear_acc_mag（線形加速度の大きさ）
  - linear_acc_mag_jerk（線形加速度大きさの微分）
  - angular_vel_x/y/z（四元数から計算した角速度、Polarsで実装）
  - angular_distance（連続する四元数間の角距離、Polarsで実装）

### exp015のIMUFeatureExtractor（model.py内で処理）
- **基本IMUデータ**: 7次元（元データをそのまま含む）
- **物理ベース特徴量**: 9次元（exp013から移植）
- **追加特徴量**: 23次元（参考notebookから適応）
- **合計**: 39次元

### 問題点
exp015のIMUFeatureExtractorの物理ベース特徴量計算（重力除去、角速度計算、角距離計算）は、exp013のPolars実装からPyTorchに移植されたが、計算ロジックに差異がある可能性があります。

## 実装方針

exp015のIMUFeatureExtractorを修正し、exp013と同じ特徴量を生成するようにします。

### 修正対象

#### 1. 重力除去計算の修正
**exp013の実装**: 
```python
# 重力ベクトル（センサ座標）
gx = 19.62 * (xn * zn - wn * yn)
gy = 19.62 * (wn * xn + yn * zn)  
gz = 9.81 - 19.62 * (xn * xn + yn * yn)
```

**exp015の実装**:
```python 
# 重力ベクトル（センサ座標）
gx = 19.62 * (qx * qz - qw * qy)
gy = 19.62 * (qw * qx + qy * qz)
gz = 9.81 - 19.62 * (qx * qx + qy * qy)
```
→ 符号処理や数値定数は一致しているが、四元数の順序に注意が必要

#### 2. 角速度計算の修正
**exp013の実装**:
- 連続性のための符号合わせ（dot < 0なら後者を反転）
- delta = q1^{-1} * q2 = conj(q1) * q2 を計算
- 回転ベクトルから角速度を計算
- 数値安定化のためarctan2使用

**exp015の実装**:
- 四元数の微分から角速度を計算
- ω = 2 * q_dot * q_conjugate
- 符号合わせの処理が不足

#### 3. 角距離計算の修正  
**exp013の実装**:
- q と -q の同値対策（最短経路）
- delta = q1^{-1} * q2 を計算
- arctan2使用で数値安定性確保

**exp015の実装**:
- 内積から角距離を計算
- arccos使用で数値範囲に注意が必要

## 実装タスク

### タスク1: exp015をexp016にコピー
```bash
cp -r codes/exp/exp015 codes/exp/exp016
```

### タスク2: IMUFeatureExtractorの修正
`codes/exp/exp016/model.py`のIMUFeatureExtractorクラスを修正：

1. **重力除去計算の調整**
   - exp013の計算式と完全一致させる
   - 四元数の順序と符号を確認

2. **角速度計算の実装変更**
   - exp013のPolars実装をPyTorchで再実装
   - 連続性のための符号合わせ処理を追加
   - delta quaternion approach に変更

3. **角距離計算の実装変更**
   - exp013と同じアルゴリズムに変更
   - arctan2使用で数値安定性向上

4. **数値安定化の統一**
   - tolerance値の統一（1e-8）
   - クランピング処理の統一
   - NaN処理の統一

### タスク3: 特徴量次元数の確認
- 現在の39次元からexp013相当の次元数に調整
- 不要な特徴量（参考notebook由来の追加特徴量）を削除する可能性も検討

### タスク4: テストコードの更新
`tests/test_exp016_*.py`の作成：
- 特徴量計算の単体テスト
- exp013との数値比較テスト
- GPU/CPU両方での動作確認

### タスク5: configファイルの更新
- 特徴量次元数の調整
- ハイパーパラメータの調整

### タスク6: 検証とテスト
- 静的解析（ruff, mypy）の実行
- テストの実行と修正
- 小規模データでの動作確認

## 期待される効果

1. **特徴量の一貫性**: exp013と同じ物理的意味を持つ特徴量を生成
2. **計算精度の向上**: 数値安定化の改善
3. **学習性能の向上**: より適切な特徴量による分類性能の改善

## リスクと対策

1. **計算精度の差異**
   - 対策: 単体テストで数値誤差を確認、許容誤差内での一致を検証

2. **学習の不安定化**
   - 対策: 特徴量の正規化を適切に実施、勾配クリッピングの検討

3. **計算速度の低下**
   - 対策: バッチ処理の最適化、必要に応じてバッチサイズ調整

## 成功指標

1. exp013とexp016の特徴量が数値的に一致（許容誤差内）
2. 全テストが通ること
3. 静的解析をパスすること
4. 学習が正常に実行できること
